{"Name":"Add Note to IOCs","Description":"This action adds a note to an existing threat data object.","Script":"from __future__ import annotations\n\nimport json\n\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import output_handler\n\nfrom api_manager import APIManager\nfrom constants import (\n    ADD_NOTE_TO_IOC_SCRIPT_NAME,\n    COMMON_ACTION_ERROR_MESSAGE,\n    NO_ENTITIES_ERROR,\n    NO_VALID_IOC_ERROR,\n    RESULT_VALUE_FALSE,\n    RESULT_VALUE_TRUE,\n)\nfrom cyware_exceptions import CywareException\nfrom utils import get_entities, get_integration_params\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = ADD_NOTE_TO_IOC_SCRIPT_NAME\n    siemplify.LOGGER.info(\"----------------- Main - Param Init -----------------\")\n\n    output_message = \"\"\n    status = EXECUTION_STATE_COMPLETED\n    result_value = RESULT_VALUE_FALSE\n    json_results = []\n\n    try:\n        base_url, access_id, secret_key, verify_ssl = get_integration_params(siemplify)\n        ioc_values = get_entities(siemplify)\n        note = siemplify.extract_action_param(\"Note\", print_value=False, is_mandatory=True)\n        note_type = siemplify.extract_action_param(\"Note Type\", print_value=True, is_mandatory=True)\n        is_json_str = siemplify.extract_action_param(\n            \"Is the Note in Json format\", print_value=True, default_value=\"false\"\n        )\n\n        siemplify.LOGGER.info(\"----------------- Main - Started -----------------\")\n\n        if not ioc_values:\n            output_message = NO_ENTITIES_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n\n        is_json = is_json_str.lower() == \"true\"\n\n        if is_json:\n            parsed_note = json.loads(note)\n            note = json.dumps(parsed_note)\n\n        cyware_manager = APIManager(\n            base_url.strip(), access_id, secret_key, verify_ssl=verify_ssl, siemplify=siemplify\n        )\n\n        siemplify.LOGGER.info(\"Fetching indicator IDs from provided name via bulk IOC lookup.\")\n        ioc_lookup = cyware_manager.lookup_iocs(ioc_values)\n        missing_iocs = [value for value in ioc_values if value not in ioc_lookup]\n        if missing_iocs:\n            siemplify.LOGGER.info(\n                f\"Indicator(s) not found on Cyware Intel Exchange and will be skipped: \"\n                f\"{', '.join(missing_iocs)}\"\n            )\n        valid_iocs = [value for value in ioc_values if value in ioc_lookup]\n\n        if not valid_iocs:\n            output_message = NO_VALID_IOC_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n\n        indicator_responses = []\n        successful_indicators = []\n        failed_indicators = []\n\n        for indicator_value in valid_iocs:\n            indicator_id = ioc_lookup[indicator_value]\n\n            try:\n                response = cyware_manager.add_note_to_indicator(\n                    object_id=indicator_id, text=note, note_type=note_type, is_json=is_json\n                )\n\n                indicator_responses.append({\n                    \"indicator\": indicator_value,\n                    \"indicator_id\": indicator_id,\n                    \"response\": response or {},\n                })\n\n                if response:\n                    note_id = response.get(\"id\", \"N/A\")\n                    successful_indicators.append({\n                        \"indicator\": indicator_value,\n                        \"indicator_id\": indicator_id,\n                        \"note_id\": note_id,\n                    })\n                    siemplify.LOGGER.info(\n                        f\"Successfully added note to IOC '{indicator_value}' (ID: {indicator_id}). \"\n                        f\"Note ID: {note_id}\"\n                    )\n                else:\n                    failed_indicators.append(indicator_value)\n                    siemplify.LOGGER.warning(\n                        f\"Add note API returned empty response for IOC '{indicator_value}' \"\n                        f\"(ID: {indicator_id}).\"\n                    )\n\n            except Exception as inner_error:\n                failed_indicators.append(indicator_value)\n                siemplify.LOGGER.error(\n                    f\"Failed to Add Note to IOCs '{indicator_value}' (ID: {indicator_id}). \"\n                    f\"Error: {inner_error}\"\n                )\n                siemplify.LOGGER.exception(inner_error)\n\n        if indicator_responses:\n            json_results = json.dumps(indicator_responses, indent=4)\n\n        if successful_indicators:\n            output_message = (\n                f\"Successfully added notes to {len(successful_indicators)} IOC(s). \"\n                f\"Skipped {len(missing_iocs)} IOC(s) since they are not found on \"\n                f\"Cyware Intel Exchange\"\n            )\n            if failed_indicators:\n                output_message += (\n                    f\" Failed to add notes to {len(failed_indicators)} IOC(s): \"\n                    f\"{', '.join(failed_indicators)}.\"\n                )\n            result_value = RESULT_VALUE_TRUE\n        else:\n            output_message = \"Failed to add note to any IOC.\"\n            if failed_indicators:\n                output_message += f\" Affected IOC(s): {', '.join(failed_indicators)}.\"\n            result_value = RESULT_VALUE_FALSE\n            status = EXECUTION_STATE_FAILED\n\n    except CywareException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except json.JSONDecodeError:\n        output_message = \"Note is marked as JSON but is not valid JSON. Enter valid JSON.\"\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n\n    except Exception as e:\n        output_message = COMMON_ACTION_ERROR_MESSAGE.format(ADD_NOTE_TO_IOC_SCRIPT_NAME, e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    finally:\n        siemplify.result.add_result_json(json_results)\n        siemplify.LOGGER.info(\"----------------- Main - Finished -----------------\")\n        siemplify.LOGGER.info(f\"Status: {status}\")\n        siemplify.LOGGER.info(f\"result_value: {result_value}\")\n        siemplify.LOGGER.info(f\"Output Message: {output_message}\")\n        siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"CywareIntelExchange","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"[{\"indicator\": \"103.253.24.18\", \"indicator_id\": \"5fde2c19-7dfe-4c3c-bbcf-88074adb3956\", \"response\": {\"created\": 1770032749, \"created_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"id\": \"e38c9fc2-2dd8-48d0-83ee-7c8bdbb2e6c9\", \"is_json\": false, \"meta_data\": {}, \"modified\": 1770032749, \"modified_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"object_id\": \"5fde2c19-7dfe-4c3c-bbcf-88074adb3956\", \"source_id\": null, \"text\": \"test\", \"title\": null, \"type\": \"threat\"}}, {\"indicator\": \"45.137.22.71\", \"indicator_id\": \"dc408f54-beac-42ac-b19f-58c4db909443\", \"response\": {\"created\": 1770032749, \"created_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"id\": \"917d87b2-1813-4e78-980a-577f7c114d60\", \"is_json\": false, \"meta_data\": {}, \"modified\": 1770032749, \"modified_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"object_id\": \"dc408f54-beac-42ac-b19f-58c4db909443\", \"source_id\": null, \"text\": \"test\", \"title\": null, \"type\": \"threat\"}}, {\"indicator\": \"3.22.115.112\", \"indicator_id\": \"483cb24e-6da7-4975-85b2-581c7217d721\", \"response\": {\"created\": 1770032750, \"created_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"id\": \"32791509-9b9b-4df5-a18b-86fa076fc10d\", \"is_json\": false, \"meta_data\": {}, \"modified\": 1770032750, \"modified_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"object_id\": \"483cb24e-6da7-4975-85b2-581c7217d721\", \"source_id\": null, \"text\": \"test\", \"title\": null, \"type\": \"threat\"}}, {\"indicator\": \"a01217e58941f1705663675f9226593922c03842\", \"indicator_id\": \"a57979c3-04ad-48f1-8459-37f1f81d187a\", \"response\": {\"created\": 1770032750, \"created_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"id\": \"e7a5787b-5796-42fa-bec5-1cca17719cbd\", \"is_json\": false, \"meta_data\": {}, \"modified\": 1770032750, \"modified_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"object_id\": \"a57979c3-04ad-48f1-8459-37f1f81d187a\", \"source_id\": null, \"text\": \"test\", \"title\": null, \"type\": \"threat\"}}, {\"indicator\": \"102.103.102.103\", \"indicator_id\": \"710dc328-d027-42e3-9108-b92ee8847a33\", \"response\": {\"created\": 1770032750, \"created_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"id\": \"8f1b5ac0-a5d1-4dae-94d0-ad3ad75d0812\", \"is_json\": false, \"meta_data\": {}, \"modified\": 1770032750, \"modified_by\": {\"email\": \"anish.jain@crestdata.ai\", \"first_name\": \"Anish\", \"id\": \"8095d3e5-07b8-4478-b89f-4e75af497173\", \"last_name\": \"Jain\"}, \"object_id\": \"710dc328-d027-42e3-9108-b92ee8847a33\", \"source_id\": null, \"text\": \"test\", \"title\": null, \"type\": \"threat\"}}]","ShowResult":true}],"Creator":"2ad92bfc-4521-467b-afef-7163569481dc","IsEnabled":true,"IsCustom":true,"AiGenerated":false,"IsSystem":false,"Version":1.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"","Description":"The type of the note. (Eg. threatdata)","Name":"Note Type","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"","Description":"The description for the note.","Name":"Note","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"false","Description":"Set it to true, if the note is in JSON format.","Name":"Is the Note in Json format","Value":"false","Type":1,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","ActionType":1,"SimulationData":{"Entities":[]},"SimulationDataJson":"{\"Entities\": []}"}