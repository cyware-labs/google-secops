{"Name":"Create Intel in Cyware Intel Exchange","Description":"This action creates a new intelligence record in Cyware Intel Exchange.","Script":"from __future__ import annotations\n\nimport json\nimport time\n\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import output_handler\n\nfrom typing import Any, Dict, List\n\nfrom api_manager import APIManager\nfrom constants import (\n    COMMON_ACTION_ERROR_MESSAGE,\n    CREATE_INTEL_IN_CTIX_SCRIPT_NAME,\n    QUICK_INTEL_STATUS_FAILURE_STATUSES,\n    QUICK_INTEL_STATUS_MAX_ATTEMPTS,\n    QUICK_INTEL_STATUS_POLL_INTERVAL,\n    QUICK_INTEL_STATUS_SUCCESS_STATUSES,\n    RESULT_VALUE_FALSE,\n    RESULT_VALUE_TRUE,\n    NO_ENTITIES_ERROR,\n    NO_TITLE_ERROR\n)\nfrom cyware_exceptions import CywareException\nfrom utils import get_integration_params, get_entities, string_to_list, validate_integer_param\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = CREATE_INTEL_IN_CTIX_SCRIPT_NAME\n    siemplify.LOGGER.info(\"----------------- Main - Param Init -----------------\")\n\n    output_message = \"\"\n    status = EXECUTION_STATE_COMPLETED\n    result_value = RESULT_VALUE_FALSE\n    json_results = []\n\n    try:\n        base_url, access_id, secret_key, verify_ssl = get_integration_params(siemplify)\n        ioc_values = get_entities(siemplify)\n        ioc_type = siemplify.extract_action_param(\"IOC Type\", print_value=True, is_mandatory=True)\n        title = siemplify.extract_action_param(\"Title\", print_value=True, is_mandatory=True)\n        tlp = siemplify.extract_action_param(\"TLP\", print_value=True)\n        metadata_confidence_score = siemplify.extract_action_param(\n            \"Metadata Confidence Score\", print_value=True\n        )\n        tags = siemplify.extract_action_param(\"Tags\", print_value=True)\n        valid_until = siemplify.extract_action_param(\"Deprecates After\", print_value=True)\n        description = siemplify.extract_action_param(\"Description\", print_value=True)\n        \n        siemplify.LOGGER.info(\"----------------- Main - Started -----------------\")\n\n        if description:\n            description = description.strip()\n            if len(description) > 1000:\n                output_message = \"Description must not exceed 1000 characters.\"\n                result_value = RESULT_VALUE_FALSE\n                status = EXECUTION_STATE_FAILED\n                return\n\n        if not ioc_values:\n            output_message = NO_ENTITIES_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n        \n        if len(title.strip()) > 100:\n            output_message = \"Title must not exceed 100 characters.\"\n            result_value = RESULT_VALUE_FALSE\n            status = EXECUTION_STATE_FAILED\n            return\n\n        tags_list = string_to_list(tags, strip_quotes=True, param_name=\"Tags\") if tags else []\n        \n        confidence = None\n        if metadata_confidence_score:\n            confidence = validate_integer_param(\n                metadata_confidence_score,\n                \"Metadata Confidence Score\",\n                zero_allowed=True,\n                max_value=100,\n            )\n\n        resolved_tlp = (tlp or \"NONE\").upper()\n\n        valid_until_value = None\n        if valid_until and valid_until.strip():\n            valid_until_days = validate_integer_param(\n                valid_until.strip(),\n                \"Deprecates After\",\n                zero_allowed=False,\n                max_value=1000,\n            )\n            valid_until_value = str(valid_until_days)\n\n        cyware_manager = APIManager(\n            base_url.strip(), access_id, secret_key, verify_ssl=verify_ssl, siemplify=siemplify\n        )\n        indicator_results: List[Dict[str, Any]] = []\n        failed_indicators: List[Dict[str, str]] = []\n\n        for indicator_value in ioc_values:\n\n            metadata_payload: Dict[str, Any] = {\n                \"tlp\": resolved_tlp,\n                \"default_marking_definition\": resolved_tlp,\n                \"tags\": tags_list,\n                \"is_apply_all\": True,\n            }\n\n            if confidence is not None:\n                metadata_payload[\"confidence\"] = confidence\n            if description:\n                metadata_payload[\"description\"] = description\n            if valid_until_value:\n                metadata_payload[\"valid_until\"] = valid_until_value\n\n            body: Dict[str, Any] = {\n                \"context\": \"QUICK_ADD_INTEL_FLOW\",\n                \"metadata\": metadata_payload,\n                \"indicators\": {\n                    ioc_type: indicator_value,\n                },\n                \"title\": title.strip(),\n                \"create_intel_feed\": True,\n            }\n            if valid_until_value:\n                body[\"valid_until\"] = valid_until_value\n\n            siemplify.LOGGER.info(\n                f\"Prepared intel creation body for '{indicator_value}': {json.dumps(body)}\"\n            )\n\n            try:\n                creation_response = cyware_manager.create_intel(body)\n\n                if not creation_response:\n                    raise CywareException(\n                        f\"Failed to create intel in CTIX for IOC '{indicator_value}'.\"\n                    )\n\n                task_id = creation_response.get(\"task_id\")\n                siemplify.LOGGER.info(\n                    f\"Intel created successfully for '{indicator_value}'. Task ID: {task_id}\"\n                )\n\n                status_response = None\n                if task_id:\n                    attempt = 0\n                    while True:\n                        attempt += 1\n                        siemplify.LOGGER.info(\n                            f\"Checking quick intel status for '{indicator_value}' \"\n                            f\"(Attempt {attempt}/{QUICK_INTEL_STATUS_MAX_ATTEMPTS}).\"\n                        )\n                        status_response = cyware_manager.get_quick_intel_status(task_id)\n                        report_status = (status_response.get(\"report_status\") or \"\").upper()\n\n                        if report_status in QUICK_INTEL_STATUS_SUCCESS_STATUSES:\n                            break\n                        if report_status in QUICK_INTEL_STATUS_FAILURE_STATUSES:\n                            raise CywareException(\n                                f\"Quick intel processing failed for '{indicator_value}' \"\n                                f\"with status '{report_status}'.\"\n                            )\n                        if attempt >= QUICK_INTEL_STATUS_MAX_ATTEMPTS:\n                            raise CywareException(\n                                f\"Timed out while waiting for quick intel report to complete \"\n                                f\"for '{indicator_value}'.\"\n                            )\n                        time.sleep(QUICK_INTEL_STATUS_POLL_INTERVAL)\n                else:\n                    siemplify.LOGGER.warning(\n                        f\"Task ID missing in creation response for '{indicator_value}'. Skipping status check.\"\n                    )\n\n                indicator_results.append(\n                    {\n                        \"indicator\": indicator_value,\n                        \"creation_response\": creation_response,\n                        \"status_response\": status_response,\n                    }\n                )\n\n            except Exception as inner_error:\n                failed_indicators.append(\n                    {\"indicator\": indicator_value, \"error\": str(inner_error)}\n                )\n                siemplify.LOGGER.error(\n                    f\"Failed to process IOC '{indicator_value}': {inner_error}\"\n                )\n                siemplify.LOGGER.exception(inner_error)\n\n        if indicator_results:\n            json_results = json.dumps(indicator_results, indent=4)\n\n        success_count = len(indicator_results)\n        failure_count = len(failed_indicators)\n\n        if success_count:\n            output_message = (\n                f\"Successfully created intel in CTIX for {success_count} IOC(s).\"\n            )\n            if failure_count:\n                failed_values = \", \".join(\n                    f\"{failure.get('indicator', 'N/A')} (Reason: {failure.get('error', 'Unknown error')})\"\n                    for failure in failed_indicators\n                )\n                output_message += (\n                    f\" Failed to create intel for {failure_count} IOC(s): {failed_values}.\"\n                )\n            result_value = RESULT_VALUE_TRUE\n        else:\n            output_message = \"Failed to create intel in CTIX for all provided IOCs.\"\n            if failure_count:\n                failed_values = \", \".join(\n                    f\"{failure.get('indicator', 'N/A')} (Reason: {failure.get('error', 'Unknown error')})\"\n                    for failure in failed_indicators\n                )\n                output_message += f\" Affected IOC(s): {failed_values}.\"\n            result_value = RESULT_VALUE_FALSE\n            status = EXECUTION_STATE_FAILED\n\n    except CywareException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except Exception as e:\n        output_message = COMMON_ACTION_ERROR_MESSAGE.format(CREATE_INTEL_IN_CTIX_SCRIPT_NAME, e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n    \n    finally:\n        siemplify.result.add_result_json(json_results)\n        siemplify.LOGGER.info(\"----------------- Main - Finished -----------------\")\n        siemplify.LOGGER.info(f\"Status: {status}\")\n        siemplify.LOGGER.info(f\"result_value: {result_value}\")\n        siemplify.LOGGER.info(f\"Output Message: {output_message}\")\n        siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"CywareIntelExchange","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"[\n    {\n        \"indicator\": \"https://www.google.com/\",\n        \"creation_response\": {\n            \"details\": \"You will be notified once the STIX is created\",\n            \"task_id\": \"77d599e8-7401-4f43-8263-44d5ea0903ba\"\n        },\n        \"status_response\": {\n            \"report_id\": \"722525b2-0134-4bb7-ae01-fab9b798cb1b\",\n            \"report_status\": \"CREATED\"\n        }\n    },\n    {\n        \"indicator\": \"https://www.secops.com/\",\n        \"creation_response\": {\n            \"details\": \"You will be notified once the STIX is created\",\n            \"task_id\": \"14f5ece1-28f9-4194-bf51-be4f8ff6e1fd\"\n        },\n        \"status_response\": {\n            \"report_id\": \"722525b2-0134-4bb7-ae01-fab9b798cb1b\",\n            \"report_status\": \"CREATED\"\n        }\n    }\n]","ShowResult":true}],"Creator":"2e061c1d-543b-424b-ae08-f89e633463f3","IsEnabled":true,"IsCustom":true,"AiGenerated":false,"IsSystem":false,"Version":20.0,"TimeoutSeconds":1200,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"[Alert.Name]","Description":"Pass a title for the intel within 100 characters. The title is added to the report object that is created as part of the quick add intel submission.","Name":"Title","Value":"[Alert.Name]","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"NONE","Description":"Pass the TLP value for the intel.","Name":"TLP","Value":"NONE","Type":15,"OptionalValues":["RED","CLEAR","AMBER","AMBER_STRICT","NONE","GREEN"],"OptionalValuesJson":"[\"RED\",\"CLEAR\",\"AMBER\",\"AMBER_STRICT\",\"NONE\",\"GREEN\"]"},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"","Description":"Pass a Source Confidence Score for the intel between 0 and 100.","Name":"Metadata Confidence Score","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"","Description":"Pass Comma Separated Tag names to add to the intel","Name":"Tags","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"180","Description":"Provide the expiration time of the indicator in Days. Maximum value is 1000 days","Name":"Deprecates After","Value":"180","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"","Description":"Pass a description for the intel within 1000 characters.","Name":"Description","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"ipv4-addr","Description":"Pass the type of indicator.","Name":"IOC Type","Value":"ipv4-addr","Type":15,"OptionalValues":["ipv4-addr","ipv6-addr","domain-name","url","autonomous-system","email-addr","file","MD5","network-traffic","SHA-1","SHA-224","SHA-256","SHA-384","SHA-512","SSDEEP","windows-registry-key","artifact","directory","email-message","mac-addr","mutex","process","SHA3-224","SHA3-256","SHA3-384","SHA3-512","software","user-account","x509-certficate","yara"],"OptionalValuesJson":"[\"ipv4-addr\",\"ipv6-addr\",\"domain-name\",\"url\",\"autonomous-system\",\"email-addr\",\"file\",\"MD5\",\"network-traffic\",\"SHA-1\",\"SHA-224\",\"SHA-256\",\"SHA-384\",\"SHA-512\",\"SSDEEP\",\"windows-registry-key\",\"artifact\",\"directory\",\"email-message\",\"mac-addr\",\"mutex\",\"process\",\"SHA3-224\",\"SHA3-256\",\"SHA3-384\",\"SHA3-512\",\"software\",\"user-account\",\"x509-certficate\",\"yara\"]"}],"DefaultResultValue":"","PythonVersion":"None","ActionType":1,"SimulationData":{"Entities":null},"SimulationDataJson":null}