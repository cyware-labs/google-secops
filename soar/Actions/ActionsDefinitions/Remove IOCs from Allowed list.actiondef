{"Name":"Remove IOCs from Allowed list","Description":"This action unmarks IOCs from allowed list (un_whitelist).","Script":"from __future__ import annotations\n\nimport json\n\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import output_handler\n\nfrom api_manager import APIManager\nfrom constants import (\n    COMMON_ACTION_ERROR_MESSAGE,\n    NO_ENTITIES_ERROR,\n    NO_VALID_IOC_ERROR,\n    REMOVE_ALLOWED_IOCS_SCRIPT_NAME,\n    RESULT_VALUE_FALSE,\n    RESULT_VALUE_TRUE,\n)\nfrom cyware_exceptions import CywareException\nfrom utils import get_entities, get_integration_params\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = REMOVE_ALLOWED_IOCS_SCRIPT_NAME\n    siemplify.LOGGER.info(\"----------------- Main - Param Init -----------------\")\n\n    output_message = \"\"\n    status = EXECUTION_STATE_COMPLETED\n    result_value = RESULT_VALUE_FALSE\n    json_results = []\n\n    try:\n        base_url, access_id, secret_key, verify_ssl = get_integration_params(siemplify)\n        siemplify.LOGGER.info(\"----------------- Main - Started -----------------\")\n        entities = get_entities(siemplify)\n        if not entities:\n            output_message = NO_ENTITIES_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n\n        cyware_manager = APIManager(\n            base_url.strip(), access_id, secret_key, verify_ssl=verify_ssl, siemplify=siemplify\n        )\n        siemplify.LOGGER.info(\"Fetching indicator IDs from provided name via bulk IOC lookup.\")\n        ioc_lookup = cyware_manager.lookup_iocs(entities)\n        missing_iocs = [value for value in entities if value not in ioc_lookup]\n        if missing_iocs:\n            siemplify.LOGGER.info(\n                f\"Indicator(s) not found on Cyware Intel Exchange and will be skipped: \"\n                f\"{', '.join(missing_iocs)}\"\n            )\n        valid_iocs = [value for value in entities if value in ioc_lookup]\n        indicator_ids = [ioc_lookup[value] for value in valid_iocs]\n\n        if not indicator_ids:\n            output_message = NO_VALID_IOC_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n\n        response = cyware_manager.remove_allowed_iocs(indicator_ids=indicator_ids)\n\n        if response:\n            json_results = json.dumps(response, indent=4)\n            message = response.get(\"message\", \"\")\n            output_message = (\n                f\"Successfully removed {len(indicator_ids)} indicator(s) from allowed list. \"\n                f\"{message}\"\n            )\n            result_value = RESULT_VALUE_TRUE\n            siemplify.LOGGER.info(f\"Remove IOCs from Allowlist response: {json.dumps(response)}\")\n        else:\n            output_message = \"Failed to Remove IOCs from Allowlist.\"\n            result_value = RESULT_VALUE_FALSE\n\n    except CywareException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except Exception as e:\n        output_message = COMMON_ACTION_ERROR_MESSAGE.format(REMOVE_ALLOWED_IOCS_SCRIPT_NAME, e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    finally:\n        siemplify.result.add_result_json(json_results)\n        siemplify.LOGGER.info(\"----------------- Main - Finished -----------------\")\n        siemplify.LOGGER.info(f\"Status: {status}\")\n        siemplify.LOGGER.info(f\"result_value: {result_value}\")\n        siemplify.LOGGER.info(f\"Output Message: {output_message}\")\n        siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"CywareIntelExchange","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{\"message\": \"Action Successfully Executed\"}","ShowResult":true}],"Creator":"2ad92bfc-4521-467b-afef-7163569481dc","IsEnabled":true,"IsCustom":true,"AiGenerated":false,"IsSystem":false,"Version":1.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[],"DefaultResultValue":"","PythonVersion":"None","ActionType":1,"SimulationData":{"Entities":[]},"SimulationDataJson":"{\"Entities\": []}"}