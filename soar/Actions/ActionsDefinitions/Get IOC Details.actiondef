{"Name":"Get IOC Details","Description":"This Action performs a lookup for threat data objects in Intel Exchange and retrieves the details of the objects, such as basic details, enriched data, and relations.","Script":"from __future__ import annotations\n\nimport json\n\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import construct_csv, output_handler\n\nimport datamodels\nfrom api_manager import APIManager\nfrom constants import (\n    COMMON_ACTION_ERROR_MESSAGE,\n    GET_IOC_DETAILS_BY_ENRICHING_ENTITIES_SCRIPT_NAME,\n    MAX_TABLE_RECORDS,\n    NO_ENTITIES_ERROR,\n    RESULT_VALUE_FALSE,\n    RESULT_VALUE_TRUE,\n)\nfrom cyware_exceptions import CywareException, InvalidFormatException, InvalidIntegerException\nfrom utils import get_entities, get_entities_object, get_integration_params\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = GET_IOC_DETAILS_BY_ENRICHING_ENTITIES_SCRIPT_NAME\n    siemplify.LOGGER.info(\"----------------- Main - Param Init -----------------\")\n\n    output_message = \"\"\n    status = EXECUTION_STATE_COMPLETED\n    result_value = RESULT_VALUE_FALSE\n    json_results = []\n\n    try:\n        base_url, access_id, secret_key, verify_ssl = get_integration_params(siemplify)\n        enrichment_data_str = siemplify.extract_action_param(\n            \"Enrichment Data\", print_value=True, default_value=\"False\"\n        )\n        relation_data_str = siemplify.extract_action_param(\n            \"Relation Data\", print_value=True, default_value=\"False\"\n        )\n        fields_str = siemplify.extract_action_param(\"Fields\", print_value=True)\n\n        siemplify.LOGGER.info(\"----------------- Main - Started -----------------\")\n\n        ioc_values = get_entities(siemplify)\n        fields = None\n        if fields_str and fields_str.strip():\n            normalized_fields = [part.strip() for part in fields_str.split(\",\") if part.strip()]\n            if normalized_fields:\n                fields = \",\".join(normalized_fields)\n\n        if not ioc_values:\n            output_message = NO_ENTITIES_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n\n        enrichment_data = enrichment_data_str.lower() == \"true\"\n        relation_data = relation_data_str.lower() == \"true\"\n\n        cyware_manager = APIManager(\n            base_url.strip(), access_id, secret_key, verify_ssl=verify_ssl, siemplify=siemplify\n        )\n\n        response = cyware_manager.get_ioc_details(\n            ioc_values=ioc_values,\n            enrichment_data=enrichment_data,\n            relation_data=relation_data,\n            fields=fields,\n        )\n\n        results = response.get(\"results\", [])\n\n        if results:\n            json_results = json.dumps(response, indent=4)\n            ioc_details = [datamodels.IOCDetails(ioc) for ioc in results]\n            csv_output = [ioc_detail.to_csv() for ioc_detail in ioc_details]\n\n            # Limit table rows for display\n            if len(csv_output) > MAX_TABLE_RECORDS:\n                csv_output = csv_output[:MAX_TABLE_RECORDS]\n                output_message = (\n                    f\"Successfully retrieved details for {len(results)} IOCs. \"\n                    f\"Showing first {MAX_TABLE_RECORDS} records in table.\"\n                )\n            else:\n                output_message = f\"Successfully retrieved details for {len(results)} IOCs.\"\n\n            siemplify.result.add_data_table(\"IOC Details\", construct_csv(csv_output), \"CTIX\")\n            siemplify.LOGGER.info(f\"Retrieved {len(results)} IOC details\")\n            result_value = RESULT_VALUE_TRUE\n\n            # Get all entities and create IOC values set for filtering\n            entities_object = get_entities_object(siemplify)\n            siemplify.LOGGER.info(f\"Found {len(entities_object)} entities\")\n\n            # Create set of IOC values from results for efficient lookup\n            ioc_values_set = {ioc.get(\"name\", \"\").lower() for ioc in results if ioc.get(\"name\")}\n\n            # Filter entities to keep only those present in results\n            filtered_entities = [\n                entity for entity in entities_object if entity.identifier.lower() in ioc_values_set\n            ]\n            siemplify.LOGGER.info(\n                f\"Filtered to {len(filtered_entities)} entities present in results\"\n            )\n\n            # Create entity map and successful entities list\n            entity_map = {entity.identifier.lower(): entity for entity in filtered_entities}\n            successful_entities = []\n\n            # Enrich entities using IOCDetails datamodel\n            for ioc_detail in ioc_details:\n                ioc_value = (\n                    ioc_detail.name\n                    if ioc_detail.name and ioc_detail.name != \"N/A\"\n                    else ioc_detail.raw_data.get(\"value\", \"\")\n                )\n                if ioc_value:\n                    entity = entity_map.get(ioc_value.lower())\n                    if entity:\n                        # Use datamodel for enrichment\n                        entity.additional_properties.update(ioc_detail.enrich_data())\n                        entity.is_enriched = True\n                        successful_entities.append(entity)\n                        siemplify.LOGGER.info(f\"Successfully enriched entity: {entity.identifier}\")\n\n            # Update entities in Siemplify\n            if successful_entities:\n                siemplify.update_entities(successful_entities)\n                siemplify.LOGGER.info(f\"Updated {len(successful_entities)} entities\")\n\n        else:\n            output_message = \"No IOC details found.\"\n            result_value = RESULT_VALUE_TRUE\n\n    except InvalidIntegerException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except InvalidFormatException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except CywareException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except Exception as e:\n        output_message = COMMON_ACTION_ERROR_MESSAGE.format(\n            GET_IOC_DETAILS_BY_ENRICHING_ENTITIES_SCRIPT_NAME, e\n        )\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    finally:\n        siemplify.LOGGER.info(\"----------------- Main - Finished -----------------\")\n        siemplify.result.add_result_json(json_results)\n        siemplify.LOGGER.info(f\"Status: {status}\")\n        siemplify.LOGGER.info(f\"result_value: {result_value}\")\n        siemplify.LOGGER.info(f\"Output Message: {output_message}\")\n        siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"CywareIntelExchange","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{\"next\": null, \"previous\": null, \"total\": 5, \"results\": [{\"analyst_score\": null, \"analyst_tlp\": null, \"country\": \"United States\", \"created\": \"2025-12-22T18:23:10.483000+00:00\", \"ctix_created\": \"2025-12-22T18:24:02.459000+00:00\", \"ctix_modified\": \"2026-02-02T16:39:30.289257+00:00\", \"custom_attributes\": null, \"confidence_score\": 0, \"description\": null, \"first_seen\": null, \"id\": \"483cb24e-6da7-4975-85b2-581c7217d721\", \"ioc_type\": \"ipv4-addr\", \"is_deprecated\": false, \"is_false_positive\": false, \"is_reviewed\": false, \"is_whitelisted\": true, \"last_seen\": null, \"modified\": \"2026-01-31T17:57:40.952000+00:00\", \"name\": \"3.22.115.112\", \"object_type\": \"indicator\", \"published_collections\": [{\"name\": \"rasheed_collection\", \"id\": \"20bbe284-1469-4518-a1af-72f20e687605\"}, {\"name\": \"Subs Polling (Tharun)\", \"id\": \"193e75ef-96e6-4a71-a61a-e0c80a756cd7\"}], \"relations\": {\"report\": [\"Torq Moves SOCs Beyond SOAR With AI-Powered Hyper Automation\", \"Out-of-the-Box Expectations for 2026 Reveal a Grab-Bag of Risk\", \"2026: The Year Agentic AI Becomes the Attack-Surface Poster Child\", \"Tenable Tackles AI Governance, Shadow AI Risks, Data Exposure\", \"OpenClaw AI Runs Wild in Business Environments\", \"Chinese APTs Hacking Asian Orgs With High-End Malware\", \"From Quantum to AI Risks: Preparing for Cybersecurity's Future\", \"Trump Administration Rescinds Biden-Era SBOM Guidance\", \"More Critical Flaws on n8n Could Compromise Customer Security\", \"'Semantic Chaining' Jailbreak Dupes Gemini Nano Banana, Grok 4\", \"How Can CISOs Respond to Ransomware Getting More Violent?\", \"Months After Patch, WinRAR Bug Poised to Hit SMBs Hardest\", \"Consumers Reluctant to Shop at Stores That Don't Take Security Seriously\", \"Fortinet Confirms New Zero-Day Behind Malicious SSO Logins\", \"China-Backed 'PeckBirdy' Takes Flight for Cross-Platform Attacks\", \"Surging Cyberattacks Boost Latin America to Riskiest Region\", \"Vibe-Coded 'Sicarii' Ransomware Can't Be Decrypted\", \"AI &amp; the Death of Accuracy: What It Means for Zero-Trust\", \"Microsoft Rushes Emergency Patch for Office Zero-Day\", \"'Stanley' Toolkit Turns Chrome Into Undetectable Phishing Vector\", \"WorldLeaks Extortion Group Claims It Stole 1.4TB of Nike Data\", \"Beauty in Destruction: Exploring Malware's Impact Through Art\", \"Hand CVE Over to the Private Sector\", \"Sandworm Blamed for Wiper Attack on Poland Power Grid\", \"Swipe, Plug-in, Pwned: Researchers Find New Ways to Hack Vehicles\", \"Exploited Zero-Day Flaw in Cisco UC Could Affect Millions\", \"Dark Reading Confidential: Reviving the Hacker Ethos That Built Cybersecurity\", \"Healthy Security Cultures Thrive on Risk Reporting\", \"Risky Chinese Electric Buses Spark Aussie Gov't Review\", \"Fortinet Firewalls Hit With Malicious Configuration Changes\", \"From a Whisper to a Scream: Europe Frets About Overreliance on US Tech\", \"Latin American Orgs Lack Confidence in Cyber Defenses, Skills\", \"AI Agents Undermine Progress in Browser Security\", \"'Contagious Interview' Attack Now Delivers Backdoor Via VS Code\", \"Phishing Campaign Zeroes in on LastPass Customers\", \"Complex VoidLink Linux Malware Created by AI\", \"'Damn Vulnerable' Training Apps Leave Vendors' Clouds Exposed\", \"Vulnerabilities Threaten to Break Chainlit AI Framework\", \"Microsoft &amp; Anthropic MCP Servers At Risk of RCE, Cloud Takeovers\", \"Google Gemini Flaw Turns Calendar Invites Into Attack Vector\", \"More Problems for Fortinet: Critical FortiSIEM Flaw Exploited\", \"AI System Reduces Attack Reconstruction Time From Weeks to Hours\", \"Microsoft Disrupts Cybercrime Service RedVDS\", \"Secure Your Spot at RSAC 2026 Conference\", \"'VoidLink' Malware Poses Advanced Threat to Linux Systems\", \"Microsoft Starts 2026 With a Bang: A Freshly Exploited Zero-Day\", \"Shadow#Reactor Uses Text Files to Deliver Remcos RAT\", \"Hexnode Moves into Endpoint Security With Hexnode XDR\", \"Two Separate Campaigns Target Exposed LLM Services\", \"Notorious Russian APT Nabs Credentials From Global Targets\", \"Maximum Severity HPE OneView Flaw Exploited in the Wild\", \"Fake AI Chrome Extensions Steal 900K Users' Data\", \"ChatGPT's Memory Feature Supercharges Prompt Injection\", \"Attackers Exploit Zero-Day in End-of-Life D-Link Routers\", \"Phishers Exploit Office 365 Users Who Let Their Guard Down\", \"When the Cloud Rains on Everyone's IoT Parade\", \"Cybersecurity Predictions for 2026: Navigating the Future of Digital Threats\", \"CTO New Year Resolutions for a More Secure 2026\", \"Cybersecurity Predictions 2026: An AI Arms Race and Malware Autonomy\", \"New Tech Deployments Cyber Insurers Recommend for 2026\", \"Dark Reading Confidential: Stop Secrets Creep Across Developer Platforms\", \"5 Threats That Defined Security in 2025\", \"Amazon Fends Off 1,800 Suspected DPRK IT Job Scammers\", \"Threat Actors Exploit Zero-Day in WatchGuard Firebox Devices\", \"Uzbek Users Under Attack by Android SMS Stealers\"]}, \"sources\": [{\"id\": \"0f50b643-a054-4f2b-9ec4-f1d90e7e0113\", \"name\": \"Dark Reading - Tharun\", \"type\": \"RSS_FEED\"}], \"sub_type\": null, \"tags\": [\"newtag_2\", \"cyware-test\"], \"tlp\": \"AMBER\", \"manual_review\": false, \"valid_from\": \"2025-12-22T18:23:10.483000+00:00\", \"valid_until\": \"2026-07-30T17:57:39+00:00\"}, {\"analyst_score\": null, \"analyst_tlp\": null, \"country\": null, \"created\": \"2026-01-28T13:46:10.030000+00:00\", \"ctix_created\": \"2026-01-28T13:46:59.586000+00:00\", \"ctix_modified\": \"2026-02-02T16:39:30.289257+00:00\", \"custom_attributes\": null, \"confidence_score\": 0, \"description\": null, \"first_seen\": null, \"id\": \"a57979c3-04ad-48f1-8459-37f1f81d187a\", \"ioc_type\": \"SHA-1\", \"is_deprecated\": true, \"is_false_positive\": false, \"is_reviewed\": false, \"is_whitelisted\": false, \"last_seen\": null, \"modified\": \"2026-01-28T13:46:11.030000+00:00\", \"name\": \"a01217e58941f1705663675f9226593922c03842\", \"object_type\": \"indicator\", \"published_collections\": [{\"name\": \"srikeerthi test\", \"id\": \"11600668-1b85-4e4f-bf81-a6e33253404a\"}], \"relations\": {\"report\": [\"File (SHA-1) Added from Splunk10.2\"]}, \"sources\": [{\"id\": \"51124522-22d1-4fe6-89ef-2d5f767e1af1\", \"name\": \"Import\", \"type\": \"CUSTOM_STIX_SOURCES\"}], \"sub_type\": null, \"tags\": [\"created_from_splunk\", \"t2_file_sha1\", \"t1_file_sha1\", \"cyware-test\"], \"tlp\": \"RED\", \"manual_review\": false, \"valid_from\": \"2026-01-28T13:46:10.029000+00:00\", \"valid_until\": \"2026-01-30T13:46:06+00:00\"}, {\"analyst_score\": null, \"analyst_tlp\": \"CLEAR\", \"country\": \"Morocco\", \"created\": \"2025-12-31T11:36:39.965000+00:00\", \"ctix_created\": \"2025-12-31T11:36:44.508000+00:00\", \"ctix_modified\": \"2026-02-02T16:39:30.289257+00:00\", \"custom_attributes\": null, \"confidence_score\": 0, \"description\": null, \"first_seen\": null, \"id\": \"710dc328-d027-42e3-9108-b92ee8847a33\", \"ioc_type\": \"ipv4-addr\", \"is_deprecated\": false, \"is_false_positive\": false, \"is_reviewed\": false, \"is_whitelisted\": true, \"last_seen\": null, \"modified\": \"2026-01-19T12:16:13.701000+00:00\", \"name\": \"102.103.102.103\", \"object_type\": \"indicator\", \"published_collections\": [], \"relations\": {\"report\": [\"test231\", \"test123\", \"test\"]}, \"sources\": [{\"id\": \"51124522-22d1-4fe6-89ef-2d5f767e1af1\", \"name\": \"Import\", \"type\": \"CUSTOM_STIX_SOURCES\"}], \"sub_type\": null, \"tags\": [\".net\", \"test1\", \"cyware-test\"], \"tlp\": \"AMBER\", \"manual_review\": false, \"valid_from\": \"2025-12-31T11:36:39.964000+00:00\", \"valid_until\": \"2026-07-18T12:16:12+00:00\"}, {\"analyst_score\": null, \"analyst_tlp\": null, \"country\": \"The Netherlands\", \"created\": \"2020-08-25T20:12:21.993000+00:00\", \"ctix_created\": \"2025-12-22T16:32:53.246000+00:00\", \"ctix_modified\": \"2026-02-02T16:39:30.289257+00:00\", \"custom_attributes\": [{\"custom_attribute_value\": 100, \"custom_attribute_value_integer\": 100, \"custom_attribute_name\": \"source_threat_score\", \"custom_attribute_value_float\": 100.0}, {\"custom_attribute_value\": \"ipv4--bba77692-3e4b-5de0-a633-21e9bfd9c58c\", \"custom_attribute_name\": \"source_id\"}, {\"custom_attribute_value\": \"{\\\"mandiant_threat_rating\\\": {\\\"confidence_level\\\": \\\"Medium\\\", \\\"confidence_score\\\": 59, \\\"severity_level\\\": \\\"high\\\", \\\"severity_reason\\\": [\\\"osint\\\", \\\"attributed\\\"], \\\"threat_score\\\": 100}, \\\"mscore\\\": 58, \\\"last_seen\\\": \\\"2024-06-25T18:46:59.000Z\\\", \\\"first_seen\\\": \\\"2020-08-25T20:12:21.993Z\\\", \\\"valid_from\\\": \\\"2020-08-25T20:12:21.993Z\\\"}\", \"custom_attribute_name\": \"additional_source_metadata\"}], \"confidence_score\": 0, \"description\": null, \"first_seen\": null, \"id\": \"dc408f54-beac-42ac-b19f-58c4db909443\", \"ioc_type\": \"ipv4-addr\", \"is_deprecated\": false, \"is_false_positive\": false, \"is_reviewed\": false, \"is_whitelisted\": true, \"last_seen\": null, \"modified\": \"2025-11-17T18:22:19.559000+00:00\", \"name\": \"45.137.22.71\", \"object_type\": \"indicator\", \"published_collections\": [], \"relations\": {\"threat-actor\": [\"UNC3944\"]}, \"sources\": [{\"id\": \"44065915-cd38-4972-a321-b680483a3250\", \"name\": \"Mandiant Threat Intelligence\", \"type\": \"API_FEEDS\"}], \"sub_type\": null, \"tags\": [\"Mandiant Exclusive\", \"Mandiant/UNC3944\", \"cyware-test\"], \"tlp\": \"AMBER\", \"manual_review\": false, \"valid_from\": \"2020-08-25T20:12:21.993000+00:00\", \"valid_until\": \"2026-06-20T16:15:28+00:00\"}, {\"analyst_score\": null, \"analyst_tlp\": null, \"country\": \"Indonesia\", \"created\": \"2022-09-23T06:20:59.984000+00:00\", \"ctix_created\": \"2025-12-22T14:06:01.648000+00:00\", \"ctix_modified\": \"2026-02-02T16:39:30.289257+00:00\", \"custom_attributes\": [{\"custom_attribute_value\": 95, \"custom_attribute_value_integer\": 95, \"custom_attribute_name\": \"source_threat_score\", \"custom_attribute_value_float\": 95.0}, {\"custom_attribute_value\": \"ipv4--3eb349d5-121e-59d7-91b7-9edeb81a68cc\", \"custom_attribute_name\": \"source_id\"}, {\"custom_attribute_value\": \"{\\\"mandiant_threat_rating\\\": {\\\"confidence_level\\\": \\\"High\\\", \\\"confidence_score\\\": 91, \\\"severity_level\\\": \\\"high\\\", \\\"severity_reason\\\": [\\\"osint\\\", \\\"attributed\\\"], \\\"threat_score\\\": 95}, \\\"mscore\\\": 91, \\\"last_seen\\\": \\\"2025-10-30T02:35:16.000Z\\\", \\\"first_seen\\\": \\\"2022-09-23T06:20:59.984Z\\\", \\\"valid_from\\\": \\\"2022-09-23T06:20:59.984Z\\\"}\", \"custom_attribute_name\": \"additional_source_metadata\"}], \"confidence_score\": 0, \"description\": null, \"first_seen\": null, \"id\": \"5fde2c19-7dfe-4c3c-bbcf-88074adb3956\", \"ioc_type\": \"ipv4-addr\", \"is_deprecated\": false, \"is_false_positive\": false, \"is_reviewed\": false, \"is_whitelisted\": true, \"last_seen\": null, \"modified\": \"2025-11-01T15:25:05.928000+00:00\", \"name\": \"103.253.24.18\", \"object_type\": \"indicator\", \"published_collections\": [], \"relations\": {\"threat-actor\": [\"APT44\"]}, \"sources\": [{\"id\": \"44065915-cd38-4972-a321-b680483a3250\", \"name\": \"Mandiant Threat Intelligence\", \"type\": \"API_FEEDS\"}], \"sub_type\": null, \"tags\": [\"Mandiant/APT44\", \"cyware-test\"], \"tlp\": \"AMBER\", \"manual_review\": false, \"valid_from\": \"2022-09-23T06:20:59.984000+00:00\", \"valid_until\": \"2026-06-20T13:57:27+00:00\"}], \"page_size\": 10}","ShowResult":true}],"Creator":"2ad92bfc-4521-467b-afef-7163569481dc","IsEnabled":true,"IsCustom":true,"AiGenerated":false,"IsSystem":false,"Version":1.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"false","Description":"Include enrichment data in results","Name":"Enrichment Data","Value":"false","Type":1,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"false","Description":"Include relations in results.","Name":"Relation Data","Value":"false","Type":1,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":false,"DefaultValue":"","Description":"Specific fields to get in the response.\nEg. name,id","Name":"Fields","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null}],"DefaultResultValue":"","PythonVersion":"None","ActionType":1,"SimulationData":{"Entities":[]},"SimulationDataJson":"{\"Entities\": []}"}