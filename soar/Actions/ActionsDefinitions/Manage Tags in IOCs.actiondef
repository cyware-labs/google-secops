{"Name":"Manage Tags in IOCs","Description":"This action is used to perform add/remove tags operation on IOCs.","Script":"from __future__ import annotations\n\nimport json\n\nfrom ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyUtils import output_handler\n\nfrom api_manager import APIManager\nfrom constants import (\n    ADD_TAGS_TO_IOC_SCRIPT_NAME,\n    COMMON_ACTION_ERROR_MESSAGE,\n    NO_ENTITIES_ERROR,\n    NO_VALID_IOC_ERROR,\n    RESULT_VALUE_FALSE,\n    RESULT_VALUE_TRUE,\n)\nfrom cyware_exceptions import CywareException\nfrom utils import get_entities, get_integration_params, string_to_list\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = ADD_TAGS_TO_IOC_SCRIPT_NAME\n    siemplify.LOGGER.info(\"----------------- Main - Param Init -----------------\")\n\n    output_message = \"\"\n    status = EXECUTION_STATE_COMPLETED\n    result_value = RESULT_VALUE_FALSE\n    json_results = []\n\n    try:\n        base_url, access_id, secret_key, verify_ssl = get_integration_params(siemplify)\n        tags_str = siemplify.extract_action_param(\"Tags\", print_value=True, is_mandatory=True)\n        operation_type = siemplify.extract_action_param(\n            \"Operation Type\", print_value=True, is_mandatory=True\n        )\n        ioc_values = get_entities(siemplify)\n\n        siemplify.LOGGER.info(\"----------------- Main - Started -----------------\")\n\n        tag_names = string_to_list(tags_str, strip_quotes=True, param_name=\"Tags\")\n\n        if not ioc_values:\n            output_message = NO_ENTITIES_ERROR\n            result_value = RESULT_VALUE_TRUE\n            status = EXECUTION_STATE_COMPLETED\n            return\n\n        cyware_manager = APIManager(\n            base_url.strip(), access_id, secret_key, verify_ssl=verify_ssl, siemplify=siemplify\n        )\n\n        # Fetch tag ids from names\n        siemplify.LOGGER.info(\"Fetching tag ids from names\")\n        available_tags = cyware_manager.list_tags()\n        tag_lookup = {\n            (tag.get(\"name\") or \"\"): tag.get(\"id\")\n            for tag in available_tags\n            if tag.get(\"id\") and tag.get(\"name\")\n        }\n\n        tag_ids = [tag_lookup[tag] for tag in tag_names if tag in tag_lookup]\n        invalid_tags = [tag for tag in tag_names if tag not in tag_lookup]\n\n        if operation_type == \"Add Tag\":\n            # Perform Add Operation\n            siemplify.LOGGER.info(\"Fetching IOC ids from names\")\n            ioc_lookup = cyware_manager.lookup_iocs(ioc_values)\n            invalid_iocs = [ioc for ioc in ioc_values if ioc not in ioc_lookup]\n            object_ids = [ioc_lookup[ioc] for ioc in ioc_values if ioc in ioc_lookup]\n\n            if not object_ids:\n                output_message = NO_VALID_IOC_ERROR\n                if invalid_iocs:\n                    output_message += f\" Invalid IOC(s): {', '.join(invalid_iocs)}.\"\n                result_value = RESULT_VALUE_FALSE\n                status = EXECUTION_STATE_COMPLETED\n                return\n\n            if invalid_tags:\n                siemplify.LOGGER.info(\n                    f\"Creating the following missing tags in Cyware Intel Exchange: {invalid_tags}\"\n                )\n                for tag in invalid_tags:\n                    try:\n                        created_tag = cyware_manager.create_tag(tag)\n                        created_tag_id = created_tag.get(\"id\")\n                        if created_tag_id:\n                            tag_lookup[tag] = created_tag_id\n                            tag_ids.append(created_tag_id)\n                            siemplify.LOGGER.info(\n                                f\"Successfully created tag '{tag}' with ID {created_tag_id}.\"\n                            )\n                        else:\n                            siemplify.LOGGER.error(\n                                f\"Create tag response did not return an ID for tag '{tag}'.\"\n                            )\n                    except Exception as error:\n                        siemplify.LOGGER.error(\n                            f\"Failed to create tag '{tag}' in Cyware Intel Exchange.\"\n                        )\n                        siemplify.LOGGER.exception(error)\n\n            if not tag_ids:\n                output_message = \"No tags found to add to an IOC.\"\n                result_value = RESULT_VALUE_FALSE\n                status = EXECUTION_STATE_COMPLETED\n                return\n\n            response = cyware_manager.add_tags_to_ioc(object_ids=object_ids, tag_ids=tag_ids)\n\n            if response:\n                json_results = json.dumps(response, indent=4)\n                output_message = (\n                    f\"Successfully added {len(tag_ids)} tag(s) to {len(object_ids)} IOC(s).\"\n                )\n                notes = []\n                if invalid_iocs:\n                    notes.append(\n                        f\"Skipped invalid IOC(s) since they are not found on \"\n                        f\"Cyware Intel Exchange: {', '.join(invalid_iocs)}.\"\n                    )\n                if notes:\n                    output_message = f\"{output_message} {' '.join(notes)}\"\n                result_value = RESULT_VALUE_TRUE\n                siemplify.LOGGER.info(f\"Add tags response: {json.dumps(response)}\")\n            else:\n                output_message = \"Failed to add tags to IOCs.\"\n                result_value = RESULT_VALUE_FALSE\n        else:\n            # Perform Remove Operation\n            if not tag_ids:\n                output_message = \"No valid tags found to remove. Please verify provided tag names.\"\n                if invalid_tags:\n                    output_message += f\" Invalid tag(s): {', '.join(invalid_tags)}.\"\n                result_value = RESULT_VALUE_FALSE\n                status = EXECUTION_STATE_COMPLETED\n                return\n\n            siemplify.LOGGER.info(\"Resolving IOC values to object IDs\")\n            ioc_lookup = cyware_manager.lookup_iocs(ioc_values)\n            invalid_iocs = [ioc for ioc in ioc_values if ioc not in ioc_lookup]\n            object_ids = [ioc_lookup[ioc] for ioc in ioc_values if ioc in ioc_lookup]\n\n            if not object_ids:\n                output_message = NO_VALID_IOC_ERROR\n                if invalid_iocs:\n                    output_message += f\" Invalid IOC(s): {', '.join(invalid_iocs)}.\"\n                result_value = RESULT_VALUE_FALSE\n                return\n\n            response = cyware_manager.remove_tags_from_ioc(object_ids=object_ids, tag_ids=tag_ids)\n\n            if response:\n                json_results = json.dumps(response, indent=4)\n                output_message = (\n                    f\"Successfully removed {len(tag_ids)} tag(s) from {len(object_ids)} IOC(s).\"\n                )\n                notes = []\n                if invalid_tags:\n                    notes.append(f\"Skipped invalid tag(s): {', '.join(invalid_tags)}.\")\n                if invalid_iocs:\n                    notes.append(f\"Skipped invalid IOC(s): {', '.join(invalid_iocs)}.\")\n                if notes:\n                    output_message = f\"{output_message} {' '.join(notes)}\"\n                result_value = RESULT_VALUE_TRUE\n                siemplify.LOGGER.info(f\"Remove tags response: {json.dumps(response)}\")\n            else:\n                output_message = \"Failed to remove tags from IOCs.\"\n                result_value = RESULT_VALUE_FALSE\n\n    except CywareException as e:\n        output_message = str(e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    except Exception as e:\n        output_message = COMMON_ACTION_ERROR_MESSAGE.format(ADD_TAGS_TO_IOC_SCRIPT_NAME, e)\n        result_value = RESULT_VALUE_FALSE\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(e)\n\n    finally:\n        siemplify.LOGGER.info(\"----------------- Main - Finished -----------------\")\n        siemplify.result.add_result_json(json_results)\n        siemplify.LOGGER.info(f\"Status: {status}\")\n        siemplify.LOGGER.info(f\"result_value: {result_value}\")\n        siemplify.LOGGER.info(f\"Output Message: {output_message}\")\n        siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n","IntegrationIdentifier":"CywareIntelExchange","ScriptResultName":"ScriptResult","DynamicResultsMetadata":[{"ResultName":"JsonResult","ResultExample":"{\"message\": \"Action Successfully Executed\"}","ShowResult":true}],"Creator":"2e061c1d-543b-424b-ae08-f89e633463f3","IsEnabled":true,"IsCustom":true,"AiGenerated":false,"IsSystem":false,"Version":1.0,"TimeoutSeconds":600,"IsAsync":false,"AsyncPollingIntervalInSeconds":3600,"TotalIntervalTimeoutForAsyncInSeconds":86400,"Parameters":[{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"","Description":"Tag names to add on each IOCs. Supports comma separated values.\nEg. “test-1”, “test-2”, “test-3”","Name":"Tags","Value":"","Type":0,"OptionalValues":null,"OptionalValuesJson":null},{"CustomActionId":0,"IsMandatory":true,"DefaultValue":"Add Tag","Description":"Select the Operation type, add tag or remove tag in indicators ","Name":"Operation Type","Value":"Add Tag","Type":15,"OptionalValues":["Add Tag","Remove Tag"],"OptionalValuesJson":"[\"Add Tag\",\"Remove Tag\"]"}],"DefaultResultValue":"","PythonVersion":"None","ActionType":1,"SimulationData":{"Entities":[]},"SimulationDataJson":"{\"Entities\": []}"}